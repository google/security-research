# vulnerability

Document containing information about the vulnerability, the requirements, and the affected Linux kernel versions.

## technical details

### outlines

The root cause is an input sanitization bug in `nft_verdict_init()` (`net/netfilter/nf_tables_api.c:9814`), which allowed rule verdicts to return positive drop errors. This is classified as CVE-2024-1086.

The impact of this is a stable double-free primitive on both `struct sk_buff` objects, as well as `sk_buff->head` objects (kmalloc objects, ranging from size 256 to 65536 (assuming ipv4) a.k.a. order 4 buddy pages).

The fix for the vulnerability was simply disallowing all drop errors in `nft_verdict_init()`, as this wouldn't allow userland applications to provide any drop errors anymore. It did not make sense to the kernel developers that userland applications could do this anyways, so hence they fully disabled it.

### triggering the bug

An exploit can create a rule containing an expression which sets the verdict to `0xFFFF0000`. 

When this rule gets evaluated for an skb passing the nf_tables firewall, `nf_hook_slow()` attempts to free an skb object because `NF_DROP` is returned from the verdict mask of the rule verdict (`0xFFFF0000 (verdict) & 0x000000ff (NF_VERDICT_MASK) == 0 (NF_DROP)`). Then, `nf_hook_slow()` returns `NF_ACCEPT` (`NF_DROP_GETERR(0xFFFF0000) == NF_ACCEPT`) as if every hook/rule in the chain returned `NF_ACCEPT`. 

This causes the caller of `nf_hook_slow()` to misinterpret the situation (it believes the packet has not been freed, and should be handled), and continue parsing the packet and eventually double-free both the skb object and its skb->head object.

## requirements

Capabilities:
- `CAP_NET_ADMIN`

Kernel configuration:
- `CONFIG_NF_TABLES=y`
- `CONFIG_NETFILTER=y`

User namespaces needed:
- Yes, in order to setup rules for nf_tables to trigger the bug (`CAP_NET_ADMIN` in the current namespace should also be enough)

## version info

Commit which introduced the vuln: 
- https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=e0abdadcc6e113ed2e22c85b35007

Commit which fixed the vuln (revert of previous commit): 
- https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=f342de4e2f33e0e39165d8639387aa6c19dff660

Affected kernel versions: 
- everything between `v3.5` and `v6.8-rc1`
- excluding `v6.1.76` and higher on `v6.1.x`
- excluding `v6.6.15` and higher on `v6.6.x`
- excluding `v6.7.3` and higher on `v6.7.x`