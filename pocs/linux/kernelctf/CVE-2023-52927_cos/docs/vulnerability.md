# CVE-2023-52927

The `nft_ct_set_zone_eval()` function attaches an unconfirmed template `nf_conn` to a network packet. If source NAT is later applied to this packet via the `nf_nat_setup_info()` function, the attached template `nf_conn` is inserted into the `nf_nat_bysource` hash table. However, when the template `nf_conn` is freed via `nf_ct_destroy()`, it is not unlinked from the `nf_nat_bysource`, leaving a dangling pointer in hash table.

## Requirements to trigger the vulnerability

- Capabilites: CAP_NET_ADMIN
- Kernel configuration: CONFIG_NETFILTER=y, CONFIG_NF_TABLES=y, CONFIG_NF_CONNTRACK=y, CONFIG_NF_CONNTRACK_ZONES=y, CONFIG_NF_NAT=y
- User namespaces required: Yes

## Commit which introduced the vulnerability

https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1bc91a5ddf3eaea0e0ea957cccf3abdcfcace00e

## Commit which fixed the vulnerability

https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3fa58a6fbd1e9e5682d09cdafb08fba004cb12ec

## Affected kernel versions

- "5.18.0 - 6.1.129"
- "6.2.0 - 6.5.13"

## Affected component, subsystem

net/netfilter

## Cause

Use-after-free

## Which syscalls or syscall parameters are needed to be blocked to prevent triggering the vulnerability?

Disallow unprivileged username space
