# Vulneribility
In function `nft_rbtree_gc_elem`, it lacks a check similar to this [commit](https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/commit/net/netfilter/nft_set_rbtree.c?id=2ee52ae94baabf7ee09cf2a8d854b990dac5d0e4) for the setelement pointed to by `prev`. 
This is the existing check for looking for prev:
```c 
    while (prev) {
        rbe_prev = rb_entry(prev, struct nft_rbtree_elem, node);
        if (nft_rbtree_interval_end(rbe_prev) &&
        nft_set_elem_active(&rbe_prev->ext, genmask))
            break;
        prev = rb_prev(prev);
    }
```
and this is how it should be checked:
```c
    u8 cur_genmask = nft_genmask_cur(net);
    while (prev) {
        rbe_prev = rb_entry(prev, struct nft_rbtree_elem, node);
        if (nft_rbtree_interval_end(rbe_prev) &&
        nft_set_elem_active( &rbe_prev->ext,  genmask) &&
        nft_set_elem_active(&rbe_prev->ext, cur_genmask))
            break;
        prev = rb_prev(prev);
    }
```
The lack of this check may result in use-after-free of the set element pointed to by prev.

## Requirements to trigger the vulnerability
 - Capabilities:  `CAP_NET_ADMIN` capability is required.
 - Kernel configuration: `CONFIG_NETFILTER`, `CONFIG_NF_TABLES`
 - Are user namespaces needed?: Yes
  
## Commit which introduced the vulnerability
 - [commit c9e6978e2725a7d4b6cd23b2facd3f11422c0643](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/net/netfilter/nft_set_rbtree.c?id=c9e6978e2725a7d4b6cd23b2facd3f11422c0643)

## Commit which fixed the vulnerability
- [commit 60c0c230c6f046da536d3df8b39a20b9a9fd6af0](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/net/netfilter?id=60c0c230c6f046da536d3df8b39a20b9a9fd6af0)

## Affected kernel versions
- 6.1.9 and later
- 5.15.91 and later
- 5.10.166 and later

## Affected component, subsystem
- net/netfilter (nf_tables)

## Cause
- UAF

