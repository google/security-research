## Requirements to trigger the vulnerability

- CAP_NET_ADMIN in a namespace is required
- Kernel configuration: CONFIG_INET
- User namespaces required: Yes

## Commit which introduced the vulnerability

https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=7026b1ddb6b8d4e6ee33dc2bd06c0ca8746fa7ab

## Commit which fixed the vulnerability

https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=18685451fc4e546fc0e718580d32df3c0e5c8272

## Affected kernel versions

Introduced in 4.1. Fixed in 6.6.25, 5.10.226 and other stable trees.

## Affected component, subsystem

net/ipv4

## Description

ip_local_out() is a function responsible for sending the locally generated IPV4 packets. 
It will call the NF_INET_LOCAL_OUT netfilter hooks and eventually the dst_output().

The usual call to ip_local_out() looks like this:
```
int ip_send_skb(struct net *net, struct sk_buff *skb)
{
        int err;

        err = ip_local_out(net, skb->sk, skb);
        if (err) {
                if (err > 0)
                        err = net_xmit_errno(err);
                if (err)
                        IP_INC_STATS(net, IPSTATS_MIB_OUTDISCARDS);
        }

        return err;
}
```

Pointer to the socket associated with the skb is passed as an argument to ip_local_out() and then to all the netfilter hooks:

```
int __ip_local_out(struct net *net, struct sock *sk, struct sk_buff *skb)
{
...
        return nf_hook(NFPROTO_IPV4, NF_INET_LOCAL_OUT,
                       net, sk, skb, NULL, skb_dst(skb)->dev,
                       dst_output);
       
}
```

skb holds a reference to a socket. In normal conditions, skb is released only after its output path is finished or until the skb is received by the upper layers of the input stack (in scenarios when the outgoing packet is routed back to a local interface).
This ensures the associated socket is valid while the netfilter hooks are executing.

ip_defrag() is most often called in the input path and it calls skb_orphan()/kfree_skb() on the fragment skb, assuming it is no longer needed.
However, ip_defrag() can be also called in the output path by the netfilter conntrack hook ipv4_conntrack_defrag().

If that happens, the skb will be released and if it is a last reference to the socket, it will be released as well, causing a use-after-free when next hooks are called and in the ip_finish_output().
