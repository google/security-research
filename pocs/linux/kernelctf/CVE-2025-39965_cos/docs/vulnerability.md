Vulnerability
=============

Description
-----------

Commit `94f39804d891` ("xfrm: Duplicate SPI Handling") inadvertently removed a check that prevented the function `alloc_spi_xfrm` from assigning an SPI of zero.

When an `xfrm_state` does not have an SPI assigned, its `.id.spi` field is zero. When creating an `xfrm_state` through its constructor `xfrm_state_add` its `.id.spi` will be checked and it will only be inserted into the hash table `net->xfrm.state_byspi` if the value is not zero. Likewise the destructor `xfrm_state_delete` will check the SPI field and only remove the object from `net->xfrm.state_byspi` if the value is not zero.

When creating an `xfrm_state` object through `alloc_spi_xfrm`, it will unconditionally be added to `net->xfrm.state_byspi` even if the generated SPI is zero. A local attacker can set the range of values, that the SPI is randomly drawn from, to include only the value zero ensuring the object will remain in the hash table after freeing. The hash table is used by other functions like `xfrm_state_update` to locate an `xfrm_state` by an user provided SPI. Triggering a call to a function, that uses `net->xfrm.state_byspi` in this way, will then result in use-after-free of the `xfrm_state` object.

Requirements to trigger the vulnerability
-----------------------------------------

- Capabilities: `CAP_NET_ADMIN`
- Kernel configuration:
    - `CONFIG_XFRM`
    - either `CONFIG_XFRM_USER` or `CONFIG_NET_KEY`
    - one of `CONFIG_XFRM_AH`, `CONFIG_XFRM_ESP`, `CONFIG_XFRM_IPCOMP`
- User namespaces needed: Yes, needed to gain `CAP_NET_ADMIN`

Commit which introduced the vulnerability
-----------------------------------------

- [94f39804d891cffe4ce17737d295f3b195bc7299](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=94f39804d891)

Commit which fixed the vulnerability
------------------------------------

- in mainline: [cd8ae32e4e4652db55bce6b9c79267d8946765a9](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/net/xfrm?id=cd8ae32e4e4652db55bce6b9c79267d8946765a9)
- in 6.16.9: [a78e55776522373c446f18d5002a8de4b09e6bf7](https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a78e55776522373c446f18d5002a8de4b09e6bf7)
- in 6.12.50: [9fcedabaae0096f712bbb4ccca6a8538af1cd1c8](https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9fcedabaae0096f712bbb4ccca6a8538af1cd1c8)
- in 6.6.109: [0baf92d0b1590b903c1f4ead75e61715e50e8146](https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0baf92d0b1590b903c1f4ead75e61715e50e8146)

Affected kernel versions
------------------------

- 6.17-rc1 - 6.17-rc7
- 6.16.2 - 6.16.8
- 6.12.43 - 6.12.49
- 6.6.103 - 6.6.108

Affected component, subsystem
-----------------------------

- net/xfrm

Cause
-----

- UAF

Mitigation
----------

The vulnerability can be blocked by disallowing `XFRM_MSG_ALLOCSPI` messages on netlink sockets and `SADB_GETSPI` messages on PF_KEY sockets or by ensuring that the `min` parameter of these messages is always positive.