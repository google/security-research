CC=gcc

SOURCE_FILES = exploit.c
LIBS = nl-3 nl-xfrm-3

LIBNL_ROOT_DIR = libnl
LIBNL_URL = https://github.com/thom311/libnl/releases/download/libnl3_11_0/libnl-3.11.0.tar.gz
LIBNL_VERSION = 3.11.0
LIBNL_DIR = $(LIBNL_ROOT_DIR)/libnl-$(LIBNL_VERSION)
LIBNL_INSTALL_DIR = $(LIBNL_ROOT_DIR)/install
LIBNL_LIBS = $(LIBNL_INSTALL_DIR)/lib/libnl-3.a $(LIBNL_INSTALL_DIR)/lib/libnl-xfrm-3.a
LIBNL_CFLAGS = -O2 -fPIE

CFLAGS = -O2 -static -std=c23 -Wno-declaration-after-statement  -I $(LIBNL_INSTALL_DIR)/include/libnl3
LDFLAGS = -pthread -L $(LIBNL_INSTALL_DIR)/lib/ -lnl-3 -lnl-xfrm-3

exploit: exploit.c $(LIBNL_LIBS)
	$(CC) $(CFLAGS)  $^ $(LDFLAGS)  -o $@

.PHONY: prerequisites clean cleanall

$(LIBNL_DIR):
	mkdir -p $(LIBNL_ROOT_DIR)
	rm -R $(LIBNL_DIR) || true
	wget -P $(LIBNL_ROOT_DIR) $(LIBNL_URL)
	tar -C $(LIBNL_ROOT_DIR) -xf $(LIBNL_ROOT_DIR)/libnl-$(LIBNL_VERSION).tar.gz

$(LIBNL_LIBS): $(LIBNL_DIR) libnl.patch
	cd $(LIBNL_DIR) && ./configure CFLAGS="${LIBNL_CFLAGS}" --enable-static --prefix=`realpath ../install`
	patch -p1 --forward -d $(LIBNL_DIR) <libnl.patch || true
	cd $(LIBNL_DIR) && $(MAKE)
	cd $(LIBNL_DIR) && $(MAKE) install

prerequisites: $(LIBNL_LIBS)

clean:
	rm ./*.o || true
	rm exploit || true

cleanall: clean
	rm -R $(LIBNL_ROOT_DIR) || true
