# Vulneribility
In function `__nft_rbtree_insert`, when it calls `nft_rbtree_gc_elem`, it checks whether an element has timed out and should call gc through the following code:
```c 
    /* perform garbage collection to avoid bogus overlap reports. */
    if (nft_set_elem_expired(&rbe->ext)) {
        err = nft_rbtree_gc_elem(set, priv, rbe, genmask);
 			if (err < 0)
 				return err;
```
However, the check here does not consider whether the corresponding element is newly added in the current batch instruction. This means that if another instruction fails and a rollback occurs, the added element to be rolled back may have been released by the GC, resulting in a use-after-free issue.


## Requirements to trigger the vulnerability
 - Capabilities:  `CAP_NET_ADMIN` capability is required.
 - Kernel configuration: `CONFIG_NETFILTER`, `CONFIG_NF_TABLES`
 - Are user namespaces needed?: Yes
  
## Commit which introduced the vulnerability
 - [commit c9e6978e2725a7d4b6cd23b2facd3f11422c0643](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/net/netfilter/nft_set_rbtree.c?id=c9e6978e2725a7d4b6cd23b2facd3f11422c0643)

## Commit which fixed the vulnerability
- [commit 2ee52ae94baabf7ee09cf2a8d854b990dac5d0e4](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit?id=2ee52ae94baabf7ee09cf2a8d854b990dac5d0e4)

## Affected kernel versions
- 6.1.9 - 6.1.56
- 5.15.91 - 5.15.134

## Affected component, subsystem
- net/netfilter (nf_tables)

## Cause
- UAF

