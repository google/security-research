# Vulneribility
 In 'bpf_test_run', it applies for cgroup storage through the following code:
 ```
 static int bpf_test_run(struct bpf_prog *prog, void *ctx, u32 repeat,
			u32 *retval, u32 *time, bool xdp)
{
    ...
	for_each_cgroup_storage_type(stype) {
		item.cgroup_storage[stype] = bpf_cgroup_storage_alloc(prog, stype);#here alloc the memory
		if (IS_ERR(item.cgroup_storage[stype])) {
			item.cgroup_storage[stype] = NULL;
			for_each_cgroup_storage_type(stype)
				bpf_cgroup_storage_free(item.cgroup_storage[stype]);
			return -ENOMEM;
		}
	}
    ...
 ```
The following situations are not considered when applying for cgroup storage here: Assuming there is ebpf program A, the code is as follows:

```
BPF_LD_MAP_FD(BPF_REG_2, cgroup_map0), //here will call bpf_cgroup_storage_assign
BPF_LD_MAP_FD(BPF_REG_2, prog_array_map),
BPF_MOV64_IMM(BPF_REG_3, 0),
BPF_RAW_INSN(BPF_JMP | BPF_CALL, 0, 0, 0, BPF_FUNC_tail_call),//( 1 )
BPF_MOV64_IMM(BPF_REG_0, 0),
BPF_EXIT_INSN(),
```
When program A calls program B through tail call at position (1):

```
BPF_LD_MAP_FD(BPF_REG_1, cgroup_map1),
BPF_MOV64_IMM(BPF_REG_2, 0), //BPF_CGROUP_STORAGE_SHARED
BPF_RAW_INSN(BPF_JMP | BPF_CALL, 0, 0, 0, BPF_FUNC_get_local_storage),
...
```

At this time, if you run program A through 'bpf_test_run', when applying for cgroup storage through the above code, it will be applied according to 'cgroup_map0->value_size' in program A; and when loading program B, the verifier will think that the map value size obtained by 'BPF_FUNC_get_local_storage' is the size of 'cgroup_map1->value_size'. This will eventually lead to out-of-bounds reading and writing of the applied cgroup storage in program B.

## Requirements to trigger the vulnerability
 - Kernel configuration: `CONFIG_BPF`
 - Are user namespaces needed?: No

## Commit which introduced the vulnerability
 - [commit f42ee093be2980f2689ea7a170d580364820f48b](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/net/bpf/test_run.c?id=f42ee093be2980f2689ea7a170d580364820f48b)

## Commit which fixed the vulnerability
- [commit abad3d0bad72a52137e0c350c59542d75ae4f513](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=abad3d0bad72a52137e0c350c59542d75ae4f513))

## Affected kernel versions
- 6.6-rc1 and later 
- 6.1-rc1 and later 
- 5.15-rc1 and later 
- 5.10-rc1 and later 
- 5.4-rc1

## Affected component, subsystem
- bpf

## Cause
- out-of-bounds reads and writes