# CVE-2024-53141 Exploit

**Out-of-bounds access vulnerability in Linux kernel's netfilter**

## Overview

CVE-2024-53141 is an out-of-bounds access vulnerability in the Linux kernel's netfilter subsystem. When `tb[IPSET_ATTR_IP_TO]` is not present but `tb[IPSET_ATTR_CIDR]` exists, the values of `ip` and `ip_to` are slightly swapped, causing a missed range check for `ip` and resulting in out-of-bounds access.

## Vulnerability Details

- **CVE ID**: CVE-2024-53141
- **Affected Versions**: Linux kernel v2.7 - v6.12
- **Component**: netfilter (IP sets)
- **Impact**: Out-of-bounds access leading to potential privilege escalation
- **Fix Commit**: [35f56c554eb1](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=35f56c554eb1b56b77b3cf197a6b00922d49033d)

## Requirements

### System Requirements
- Linux system with vulnerable kernel (v2.7 - v6.12)
- User namespace support enabled
- Target kernel: lts-6.6.62 (as tested)

### Capabilities Required
- `CAP_NET_ADMIN` (achieved through user namespaces)

### Kernel Configuration
- `CONFIG_IP_SET_BITMAP_IP=y`
- `CONFIG_NETFILTER=y`
- `CONFIG_USER_NS=y`

### Build Dependencies
- `build-essential` (gcc, make)
- `wget` or `curl`
- `sha256sum` (for checksum verification)

## Installation

### 1. Install Build Dependencies

**Ubuntu/Debian:**
```bash
sudo apt update
sudo apt install build-essential wget
```

**RHEL/CentOS/Fedora:**
```bash
sudo yum install gcc make wget  # RHEL/CentOS
sudo dnf install gcc make wget  # Fedora
```

### 2. Build the Exploit

```bash
# Clone the repository (if not already done)
git clone https://github.com/google/security-research.git
cd security-research/pocs/linux/kernelctf/CVE-2024-53141_lts/exploit/lts-6.6.62/

# Build dependencies and exploit
make prerequisites
make exploit

# Or build everything in one step
make all
```

### 3. Verify Build

```bash
# Check if exploit was built successfully
ls -la exploit
file exploit
```

## Usage

### Basic Execution
```bash
# Run the exploit
make run

# Or run directly
./exploit
```

### Manual Execution
```bash
# Create user namespace to get CAP_NET_ADMIN
unshare -U -r ./exploit
```

## Understanding the Vulnerability

The vulnerability exists in the netfilter IP set bitmap implementation:

1. **Root Cause**: When parsing netlink attributes, the code incorrectly handles the case where `IPSET_ATTR_IP_TO` is missing but `IPSET_ATTR_CIDR` is present
2. **Impact**: This leads to swapped `ip` and `ip_to` values and a missed range check
3. **Exploitation**: The out-of-bounds access can be leveraged for memory corruption

## Security Considerations

⚠️ **WARNING**: This exploit is for educational and research purposes only.

- Only run on systems you own or have explicit permission to test
- This exploit can cause system instability or crashes
- Ensure you have proper backups before testing

## Troubleshooting

### Build Issues

**"wget: command not found"**
```bash
# Install wget or curl
sudo apt install wget curl
```

**"gcc: command not found"**
```bash
# Install build tools
sudo apt install build-essential
```

**"sha256sum verification failed"**
```bash
# Clean and retry
make clean
make prerequisites
```

### Runtime Issues

**"Operation not permitted"**
- Ensure user namespaces are enabled
- Try running with: `unshare -U -r ./exploit`

**"No such file or directory" for network features**
- Check if required kernel configs are enabled:
```bash
zcat /proc/config.gz | grep CONFIG_IP_SET_BITMAP_IP
zcat /proc/config.gz | grep CONFIG_NETFILTER
```

**Kernel crash or hang**
- This may be expected behavior for a successful exploit
- Ensure you're testing in a VM or isolated environment

## Testing Environment

This exploit has been tested on:
- Kernel version: 6.6.62 (LTS)
- Distribution: Ubuntu 22.04 LTS
- Architecture: x86_64

## References

- [CVE-2024-53141 MITRE](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-53141)
- [Fix Commit](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=35f56c554eb1b56b77b3cf197a6b00922d49033d)
- [Google Security Research](https://github.com/google/security-research)

## Cleanup

```bash
# Remove all build artifacts
make clean

# Remove downloaded dependencies
rm -rf libmnl_build libnftnl_build
``` 