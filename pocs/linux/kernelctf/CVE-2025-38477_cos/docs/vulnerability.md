# Vulnerability

CVE-2025-38477 is a race condition vulnerability in the Linux kernel.

It occurs when 'agg' is modified in `qfq_change_agg` (called during
`qfq_enqueue`) while other threads access it concurrently. Calling different
functions concurrently build different primitives. For example, `qfq_dump_class`
may trigger a NULL dereference, and `qfq_delete_class` may cause a
use-after-free.

Easy to trigger PoC: https://lore.kernel.org/all/aGIAbGB1VAX-M8LQ@xps/

## Requirements to trigger the vulnerability:
- Capabilities: To trigger the vulnerability, `CAP_NET_ADMIN` capability is
  required.
- Kernel configuration: `CONFIG_NET_SCHED` and `CONFIG_NET_SCH_QFQ` are required
  to trigger this vulnerability.
- Are user namespaces needed?: Yes. As this vulnerability requires
  `CAP_NET_ADMIN`, which is not usually given to the normal user, we used the
  unprivileged user namespace to achieve this capability.

## Commit which introduced the vulnerability
- This vulnerability was introduced in Linux 3.0-rc1, with commit
  [462dbc9101ac](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=462dbc9101ac)
- This commit add current version of "Quick Fair Queueing Plus Scheduler" (QFQ+)
  to the kernel.

## Commit which fixed the vulnerability
- This vulnerability was fixed with commit
[5e28d5a3f774](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=5e28d5a3f774)

## Affected kernel versions
- Linux version 3.0-rc1 - 6.16-rc6 affects to this vulnerability

## Affected component, subsystem
- Net scheduler subsystem
  
## Cause (UAF, BoF, race condition, double free, refcount overflow, etc)
- race condition