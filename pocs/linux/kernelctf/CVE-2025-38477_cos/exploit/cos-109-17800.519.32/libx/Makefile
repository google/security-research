# Default goal when you just run `make`
.DEFAULT_GOAL := all

# Tools/flags
CC       ?= gcc
CFLAGS   ?= -fPIC -w
LDLIBS   ?= -lkeyutils

# Phony targets
.PHONY: all deps build clean

all: deps build

build: libx.c libx.h kaslr.c net.c
	$(CC) $(CFLAGS) -c kaslr.c -o kaslr.o
	$(CC) $(CFLAGS) -c net.c   -o net.o
	$(CC) $(CFLAGS) -masm=intel -c libx.c -o libx.o
	$(CC) $(CFLAGS) -shared -o libx.so libx.o kaslr.o net.o $(LDLIBS)
	ar rcs libx.a libx.o kaslr.o net.o

# Installs headers/libs on Ubuntu/Debian if apt-get exists; otherwise no-op.
deps:
	@command -v apt-get >/dev/null 2>&1 || { echo "deps: apt-get not found; skipping"; exit 0; }
	@echo "Installing build deps (sudo may prompt for password)..."
	sudo apt-get update
	sudo apt-get install -y libkeyutils-dev pkg-config fuse3 libfuse3-dev || sudo apt-get install -y libfuse-dev

clean:
	rm -f libx.o kaslr.o net.o libx.so libx.a